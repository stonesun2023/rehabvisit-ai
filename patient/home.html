<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>RehabVisit AI Â· ä»Šæ—¥è®­ç»ƒ</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    :root {
      --primary-color: #4A90D9;
      --primary-light: #EBF4FF;
      --success-color: #52C41A;
      --warning-color: #FAAD14;
      --danger-color: #FF4D4F;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --bg-page: #F5F7FA;
      --bg-card: #FFFFFF;
      --border-color: #E8ECF0;
      --border-radius: 12px;
      --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      padding-bottom: 70px;
    }

    /* åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }
    .nav-left {
      display: flex;
      flex-direction: column;
    }
    .patient-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .today-date {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-color);
    }

    /* åŒºåŸŸäºŒï¼šä»Šæ—¥è¿›åº¦å¡ç‰‡ */
    .progress-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      margin: 16px 20px;
      padding: 20px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .progress-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .progress-count {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .progress-count span {
      color: var(--primary-color);
      font-weight: 600;
    }
    .progress-bar {
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .encouragement {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
    }

    /* åŒºåŸŸä¸‰ï¼šè®­ç»ƒä»»åŠ¡åˆ—è¡¨ */
    .task-list {
      padding: 0 20px;
    }
    .task-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .task-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .task-icon {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      transition: background 0.3s ease;
    }
    .task-icon.done {
      background: var(--primary-light);
    }
    .task-icon.todo {
      background: var(--bg-page);
    }
    .task-content {
      flex: 1;
      min-width: 0;
    }
    .task-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .task-desc {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      line-height: 1.4;
    }
    .task-duration {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      background: var(--primary-light);
      color: var(--primary-color);
      border-radius: 10px;
    }
    .task-action {
      flex-shrink: 0;
    }
    .complete-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      background: var(--bg-card);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    .complete-btn:hover {
      border-color: var(--success-color);
    }
    .complete-btn.done {
      border-color: var(--success-color);
      background: var(--success-color);
      cursor: default;
    }
    .complete-btn.animating {
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }

    /* æ‰“å¡é¢æ¿ */
    .checkin-panel {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: none;
    }
    .checkin-panel.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .difficulty-label {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-weight: 500;
    }
    .difficulty-options {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .difficulty-option {
      flex: 1;
      padding: 10px 8px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-card);
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .difficulty-option:hover {
      border-color: var(--primary-color);
    }
    .difficulty-option.selected {
      border-color: var(--primary-color);
      background: var(--primary-light);
    }
    .difficulty-option .emoji {
      font-size: 20px;
      display: block;
      margin-bottom: 4px;
    }
    .note-input {
      width: 100%;
      height: 40px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0 12px;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-page);
      margin-bottom: 12px;
    }
    .note-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .note-input::placeholder {
      color: var(--text-secondary);
    }
    .confirm-btn {
      width: 100%;
      height: 44px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .confirm-btn:active {
      transform: scale(0.98);
    }
    .confirm-btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
    }
    .error-hint {
      color: var(--danger-color);
      font-size: 12px;
      margin-bottom: 8px;
      display: none;
    }
    .error-hint.show {
      display: block;
    }

    /* å·²å®ŒæˆçŠ¶æ€æ˜¾ç¤º */
    .completed-info {
      margin-top: 12px;
      padding: 10px 12px;
      background: var(--primary-light);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-primary);
      display: none;
    }
    .completed-info.show {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .completed-info .difficulty-display {
      font-weight: 500;
    }

    /* åŒºåŸŸå››ï¼šåº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 20px;
    }
    .nav-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-decoration: none;
      font-size: 12px;
      color: var(--text-secondary);
      transition: color 0.3s ease;
    }
    .nav-tab.active {
      color: var(--primary-color);
    }
    .nav-tab-icon {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <!-- ä»Šæ—¥è®­ç»ƒ -->
  <!-- åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <div class="nav-left">
      <div class="patient-name">å°æ˜</div>
      <div class="today-date" id="todayDate"></div>
    </div>
    <div class="avatar" id="avatarBtn" style="cursor:pointer;" title="åˆ‡æ¢è´¦å·">å°</div>
  </div>

  <!-- åŒºåŸŸäºŒï¼šä»Šæ—¥è¿›åº¦å¡ç‰‡ -->
  <div class="progress-card">
    <div class="progress-header">
      <div class="progress-title">ä»Šæ—¥è®­ç»ƒ</div>
      <div class="progress-count"><span id="doneCount">0</span>/<span id="totalCount">5</span> å·²å®Œæˆ</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div class="encouragement" id="encouragement">ä»Šå¤©çš„è®­ç»ƒè¿˜æ²¡å¼€å§‹ï¼ŒåŠ æ²¹ï¼ğŸ’ª</div>
  </div>

  <!-- åŒºåŸŸä¸‰ï¼šè®­ç»ƒä»»åŠ¡åˆ—è¡¨ -->
  <div class="task-list" id="taskList"></div>

  <!-- åŒºåŸŸå››ï¼šåº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav">
    <a href="home.html" class="nav-tab active">
      <span class="nav-tab-icon">ğŸ </span>
      <span>è®­ç»ƒ</span>
    </a>
    <a href="chat.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ’¬</span>
      <span>é—®é—®AI</span>
    </a>
    <a href="progress.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ“ˆ</span>
      <span>è¿›å±•</span>
    </a>
  </div>

  <!-- å¼•å…¥å·¥å…·å‡½æ•° -->
  <script src="../js/utils.js"></script>
  <script>
    // ä»»åŠ¡æ•°æ®æºï¼ˆç”± loadTasks() ä» Supabase åŠ è½½ï¼‰
    window.TASKS = [];

    // ç”Ÿæˆä»Šæ—¥æ—¥æœŸ
    function formatDate() {
      const now = new Date();
      const month = now.getMonth() + 1;
      const date = now.getDate();
      const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      const day = days[now.getDay()];
      return `${month}æœˆ${date}æ—¥ Â· ${day}`;
    }

    // è·å–é¼“åŠ±è¯­
    function getEncouragement(percent) {
      if (percent === 0) return 'ä»Šå¤©çš„è®­ç»ƒè¿˜æ²¡å¼€å§‹ï¼ŒåŠ æ²¹ï¼ğŸ’ª';
      if (percent < 50) return 'å·²ç»å¼€å§‹å•¦ï¼Œç»§ç»­ä¿æŒï¼ğŸŒŸ';
      if (percent < 100) return 'å¿«å®Œæˆäº†ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼ğŸ‰';
      return 'å¤ªæ£’äº†ï¼ä»Šå¤©çš„è®­ç»ƒå…¨éƒ¨å®Œæˆï¼ğŸ†';
    }

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    function updateProgress() {
      let doneCount = 0;
      window.TASKS.forEach(task => {
        if (isTaskCompletedToday(task.id)) {
          doneCount++;
        }
      });
      const totalCount = window.TASKS.length;
      const percent = Math.round((doneCount / totalCount) * 100);

      document.getElementById('doneCount').textContent = doneCount;
      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('encouragement').textContent = getEncouragement(percent);
    }

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTasks() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = window.TASKS.map(task => {
        const isCompleted = isTaskCompletedToday(task.id);
        const log = getTaskLogToday(task.id);
        
        return `
          <div class="task-card" data-id="${task.id}">
            <div class="task-header">
              <div class="task-icon ${isCompleted ? 'done' : 'todo'}">${task.icon}</div>
              <div class="task-content">
                <div class="task-name">${task.name}</div>
                <div class="task-desc">${task.desc}</div>
                <span class="task-duration">${task.duration}</span>
              </div>
              <div class="task-action">
                <button class="complete-btn ${isCompleted ? 'done' : ''}" data-id="${task.id}">
                  ${isCompleted ? 'âœ…' : ''}
                </button>
              </div>
            </div>
            ${isCompleted && log ? `
              <div class="completed-info show">
                <span>å·²å®Œæˆ</span>
                <span class="difficulty-display">${getDifficultyEmoji(log.difficulty)} ${getDifficultyText(log.difficulty)}</span>
                ${log.note ? `<span>Â· ${log.note}</span>` : ''}
              </div>
            ` : `
              <div class="checkin-panel" id="panel-${task.id}">
                <div class="difficulty-label">ä»Šå¤©å®Œæˆå¾—æ€ä¹ˆæ ·ï¼Ÿ</div>
                <div class="difficulty-options">
                  <div class="difficulty-option" data-difficulty="1" onclick="selectDifficulty('${task.id}', 1)">
                    <span class="emoji">ğŸ˜Š</span>
                    <span>è½»æ¾</span>
                  </div>
                  <div class="difficulty-option" data-difficulty="2" onclick="selectDifficulty('${task.id}', 2)">
                    <span class="emoji">ğŸ˜</span>
                    <span>æ­£å¸¸</span>
                  </div>
                  <div class="difficulty-option" data-difficulty="3" onclick="selectDifficulty('${task.id}', 3)">
                    <span class="emoji">ğŸ˜“</span>
                    <span>æœ‰ç‚¹åƒåŠ›</span>
                  </div>
                </div>
                <input type="text" class="note-input" id="note-${task.id}" placeholder="ä»Šå¤©è¡¨ç°æ€ä¹ˆæ ·ï¼Ÿï¼ˆé€‰å¡«ï¼‰">
                <div class="error-hint" id="error-${task.id}">è¯·é€‰æ‹©å›°éš¾åº¦</div>
                <button class="confirm-btn" onclick="confirmCheckin('${task.id}')">ç¡®è®¤æ‰“å¡</button>
              </div>
            `}
          </div>
        `;
      }).join('');

      // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæœªå®Œæˆçš„ä»»åŠ¡ï¼‰
      document.querySelectorAll('.complete-btn:not(.done)').forEach(btn => {
        btn.addEventListener('click', function() {
          const taskId = this.dataset.id;
          togglePanel(taskId);
        });
      });
    }

    // å½“å‰é€‰ä¸­çš„å›°éš¾åº¦
    const selectedDifficulty = {};

    // é€‰æ‹©å›°éš¾åº¦
    function selectDifficulty(taskId, difficulty) {
      selectedDifficulty[taskId] = difficulty;
      const panel = document.getElementById(`panel-${taskId}`);
      panel.querySelectorAll('.difficulty-option').forEach(opt => {
        opt.classList.remove('selected');
        if (parseInt(opt.dataset.difficulty) === difficulty) {
          opt.classList.add('selected');
        }
      });
      // éšè—é”™è¯¯æç¤º
      document.getElementById(`error-${taskId}`).classList.remove('show');
    }

    // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
    function togglePanel(taskId) {
      const panel = document.getElementById(`panel-${taskId}`);
      if (panel) {
        panel.classList.toggle('show');
      }
    }

    // ç¡®è®¤æ‰“å¡
    function confirmCheckin(taskId) {
      const difficulty = selectedDifficulty[taskId];
      const noteInput = document.getElementById(`note-${taskId}`);
      const errorHint = document.getElementById(`error-${taskId}`);
      
      // éªŒè¯å›°éš¾åº¦
      if (!difficulty) {
        errorHint.classList.add('show');
        return;
      }

      const task = window.TASKS.find(t => t.id === taskId);
      const note = noteInput.value.trim();

      // æäº¤æ‰“å¡è®°å½•
      submitLog(taskId, task.name, difficulty, note).then(() => {
        renderTasks();
        updateProgress();
      });
    }

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('todayDate').textContent = formatDate();
  </script>

  <script type="module">
    import { supabase } from '../js/supabase-client.js'
    import { ensurePatientSession } from '../js/auth.js'

    // ç¼“å­˜ä»Šæ—¥æ‰“å¡è®°å½•ï¼Œé¿å…é‡å¤è¯·æ±‚
    let todayLogs = []

    // åŠ è½½ä»Šæ—¥æ‰“å¡è®°å½•
    async function loadTodayLogs(patientId) {
      const today = new Date().toISOString().split('T')[0]
      const { data } = await supabase
        .from('task_logs')
        .select('*')
        .eq('patient_id', patientId)
        .gte('completed_at', today + 'T00:00:00')
        .lte('completed_at', today + 'T23:59:59')
      todayLogs = data || []
    }

    // æ£€æŸ¥ä»»åŠ¡ä»Šå¤©æ˜¯å¦å·²å®Œæˆ
    window.isTaskCompletedToday = (taskId) => 
      todayLogs.some(log => log.task_id === taskId)

    // è·å–ä»»åŠ¡ä»Šå¤©çš„æ‰“å¡è®°å½•
    window.getTaskLogToday = (taskId) => 
      todayLogs.find(log => log.task_id === taskId)

    // æäº¤æ‰“å¡è®°å½•åˆ° Supabase
    window.submitLog = async function(taskId, taskName, difficulty, note) {
      const patientStr = sessionStorage.getItem('rehab_current_patient')
      const patient = JSON.parse(patientStr)
      const { data: { session } } = await supabase.auth.getSession()

      const { data, error } = await supabase.from('task_logs').insert({
        task_id: taskId,
        patient_id: patient.id,
        difficulty_level: difficulty,
        note: note || null,
        completed_at: new Date().toISOString(),
        created_by: session.user.id
      }).select()

      // æ›´æ–°ç¼“å­˜
      if (data && data[0]) {
        todayLogs.push(data[0])
      }
    }

    // ä» Supabase åŠ è½½ä»»åŠ¡åˆ—è¡¨
    async function loadTasks() {
      // ä½¿ç”¨ ensurePatientSession è·å–æ‚£è€…ä¿¡æ¯ï¼ˆè‡ªåŠ¨æ¢å¤ sessionStorageï¼‰
      const patient = await ensurePatientSession()
      if (!patient) return  // å·²è·³è½¬ï¼Œç»ˆæ­¢åç»­é€»è¾‘

      // æ›´æ–°é¡¶éƒ¨å§“åæ˜¾ç¤º
      document.querySelector('.patient-name').textContent = patient.name
      document.querySelector('.avatar').textContent = patient.name[0]

      // æ‹‰å–ä»»åŠ¡åˆ—è¡¨
      const { data: tasks } = await supabase
        .from('daily_tasks')
        .select('*')
        .eq('patient_id', patient.id)
        .order('sort_order', { ascending: true })

      if (!tasks || tasks.length === 0) {
        document.getElementById('taskList').innerHTML = 
          '<div style="text-align:center;padding:40px;color:#7F8C8D;">åŒ»ç”Ÿè¿˜æ²¡æœ‰å½•å…¥è®­ç»ƒä»»åŠ¡</div>'
        return
      }

      // åŠ è½½ä»Šæ—¥æ‰“å¡è®°å½•
      await loadTodayLogs(patient.id)

      // æŠŠä»»åŠ¡æ•°æ®èµ‹å€¼ç»™åŸæœ‰çš„ TASKS å˜é‡å¹¶æ¸²æŸ“
      window.TASKS = tasks.map(t => ({
        id: t.id,
        name: t.task_name,
        desc: t.description,
        duration: t.frequency,
        icon: 'ğŸƒ'
      }))

      updateProgress()
      renderTasks()
    }

    // ç‚¹å‡»å¤´åƒé€€å‡ºç™»å½•
    document.getElementById('avatarBtn').addEventListener('click', async () => {
      const confirmed = confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')
      if (!confirmed) return
      await supabase.auth.signOut()
      window.location.href = '../index.html'
    })

    // åŠ è½½ä»»åŠ¡
    loadTasks()
  </script>
</body>
</html>
