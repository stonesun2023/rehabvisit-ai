<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>RehabVisit AI Â· AIé—®ç­”</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    :root {
      --primary-color: #4A90D9;
      --primary-light: #EBF4FF;
      --success-color: #52C41A;
      --warning-color: #FAAD14;
      --danger-color: #FF4D4F;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --bg-page: #F5F7FA;
      --bg-card: #FFFFFF;
      --border-color: #E8ECF0;
      --border-radius: 12px;
      --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      padding-bottom: 70px;
    }

    /* åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .back-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-primary);
      text-decoration: none;
      margin-right: 8px;
    }
    .nav-center {
      flex: 1;
    }
    .nav-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .nav-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* åŒºåŸŸäºŒï¼šå¯¹è¯æ¶ˆæ¯åŒºåŸŸ */
    .chat-container {
      padding: 16px 20px 90px;
      min-height: calc(100vh - 120px);
    }
    .message {
      display: flex;
      margin-bottom: 12px;
      align-items: flex-start;
    }
    .message.user {
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .message.ai .message-avatar {
      background: var(--primary-light);
      color: var(--primary-color);
      margin-right: 8px;
    }
    .message.user .message-avatar {
      background: var(--primary-color);
      color: #fff;
      margin-left: 8px;
    }
    .message-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .message.ai .message-bubble {
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 4px 16px 16px 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .message.user .message-bubble {
      background: var(--primary-color);
      color: #fff;
      border-radius: 16px 4px 16px 16px;
    }
    .thinking-dots {
      display: flex;
      gap: 4px;
      padding: 4px 0;
    }
    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* åŒºåŸŸä¸‰ï¼šåº•éƒ¨è¾“å…¥æ  */
    .input-bar {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .input-wrapper {
      flex: 1;
      position: relative;
    }
    .message-input {
      width: 100%;
      height: 44px;
      border: 1px solid var(--border-color);
      border-radius: 22px;
      padding: 0 16px;
      font-size: 15px;
      color: var(--text-primary);
      background: var(--bg-page);
      transition: border-color 0.3s ease;
    }
    .message-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .message-input::placeholder {
      color: var(--text-secondary);
    }
    .message-input:disabled {
      background: var(--border-color);
    }
    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--primary-color);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .send-btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
    }
    .send-btn:not(:disabled):active {
      transform: scale(0.95);
    }

    /* åŒºåŸŸå››ï¼šåº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 20px;
    }
    .nav-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-decoration: none;
      font-size: 12px;
      color: var(--text-secondary);
      transition: color 0.3s ease;
    }
    .nav-tab.active {
      color: var(--primary-color);
    }
    .nav-tab-icon {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <!-- AIé—®ç­” -->
  <!-- åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <a href="home.html" class="back-btn">â†</a>
    <div class="nav-center">
      <div class="nav-title">é—®é—® AI</div>
      <div class="nav-subtitle">å°æ˜çš„åº·å¤åŠ©æ‰‹</div>
    </div>
  </div>

  <!-- åŒºåŸŸäºŒï¼šå¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
  <div class="chat-container" id="chatContainer"></div>

  <!-- åŒºåŸŸä¸‰ï¼šåº•éƒ¨è¾“å…¥æ  -->
  <div class="input-bar">
    <div class="input-wrapper">
      <input type="text" class="message-input" id="messageInput" placeholder="é—®é—®å°æ˜çš„åº·å¤æƒ…å†µâ€¦">
    </div>
    <button class="send-btn" id="sendBtn" disabled>â†‘</button>
  </div>

  <!-- åŒºåŸŸå››ï¼šåº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav">
    <a href="home.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ </span>
      <span>è®­ç»ƒ</span>
    </a>
    <a href="chat.html" class="nav-tab active">
      <span class="nav-tab-icon">ğŸ’¬</span>
      <span>é—®é—®AI</span>
    </a>
    <a href="progress.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ“ˆ</span>
      <span>è¿›å±•</span>
    </a>
  </div>

  <script type="module">
    import { supabase } from '../js/supabase-client.js'
    import { ensurePatientSession } from '../js/auth.js'

    // GLM API é…ç½®
    const GLM_API_KEY = '27b0c3b4495d41a7abd38c5666e09665.7UmdjwqfPcaHfoZO';
    const GLM_API_URL = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';

    // æ‚£è€…ä¸Šä¸‹æ–‡ï¼ˆä» sessionStorage è¯»å–ï¼‰
    let patientContext = ''
    let currentPatientId = null

    // åˆå§‹åŒ–æ‚£è€…ä¸Šä¸‹æ–‡
    async function initPatientContext() {
      const patient = await ensurePatientSession()
      if (!patient) return null

      currentPatientId = patient.id

      // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤º
      document.querySelector('.nav-subtitle').textContent = `${patient.name}çš„åº·å¤åŠ©æ‰‹`

      // æ„å»ºæ‚£è€…ä¸Šä¸‹æ–‡
      patientContext = `
æ‚£è€…ä¿¡æ¯ï¼š
- å§“åï¼š${patient.name}ï¼Œ${patient.age || 'æœªçŸ¥'}å²
- è¯Šæ–­ï¼š${patient.diagnosis || 'æœªçŸ¥'}
- å½“å‰åº·å¤ç›®æ ‡ï¼šæ”¹å–„æ­¥è¡ŒåŠŸèƒ½ï¼Œæé«˜æ—¥å¸¸ç”Ÿæ´»è‡ªç†èƒ½åŠ›

å½“å‰è®­ç»ƒè®¡åˆ’ç”±åŒ»ç”Ÿåˆ¶å®šï¼Œè¯·æ ¹æ®æ‚£è€…æƒ…å†µå›ç­”å®¶é•¿é—®é¢˜ã€‚
`
      return patient
    }

    // å¯¹è¯å†å²
    let conversationHistory = [];

    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = isUser ? 'æˆ‘' : 'AI';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = content;
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      chatContainer.appendChild(messageDiv);
      
      scrollToBottom();
      return bubble;
    }

    // æ¸²æŸ“æ€è€ƒä¸­çŠ¶æ€
    function renderThinking() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';
      messageDiv.id = 'thinkingMessage';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = 'AI';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      chatContainer.appendChild(messageDiv);
      
      scrollToBottom();
    }

    // ç§»é™¤æ€è€ƒä¸­çŠ¶æ€
    function removeThinking() {
      const thinking = document.getElementById('thinkingMessage');
      if (thinking) thinking.remove();
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ä¿å­˜å¯¹è¯è®°å½•åˆ° Supabase
    async function saveChatLog(role, content) {
      if (!currentPatientId) return
      try {
        await supabase.from('chat_logs').insert({
          patient_id: currentPatientId,
          role: role,
          content: content,
          flagged_for_doctor: false
        })
      } catch (err) {
        // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸é˜»å¡ç”¨æˆ·å¯¹è¯
        console.error('ä¿å­˜å¯¹è¯è®°å½•å¤±è´¥:', err)
      }
    }

    // ä» Supabase åŠ è½½å†å²å¯¹è¯è®°å½•
    async function loadChatHistory() {
      if (!currentPatientId) return
      try {
        const { data: logs, error } = await supabase
          .from('chat_logs')
          .select('*')
          .eq('patient_id', currentPatientId)
          .order('created_at', { ascending: true })
          .limit(50)
        
        if (error) throw error

        // æ¢å¤å¯¹è¯å†å²
        if (logs && logs.length > 0) {
          logs.forEach(log => {
            // æ¸²æŸ“æ¶ˆæ¯
            renderMessage(log.content, log.role === 'user')
            // æ·»åŠ åˆ°å¯¹è¯å†å²ï¼ˆç”¨äº API è°ƒç”¨ï¼‰
            conversationHistory.push({ role: log.role, content: log.content })
          })
        }
      } catch (err) {
        console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', err)
      }
    }

    // å‘é€æ¶ˆæ¯åˆ° GLM
    async function sendToGLM(userMessage) {
      // æ„å»ºç³»ç»Ÿæç¤º
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åº·å¤åŒ»å­¦ç§‘AIåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºæ‚£è€…å®¶é•¿æä¾›æ”¯æŒã€‚

ã€æ‚£è€…ä¿¡æ¯ã€‘
${patientContext}

ã€ä½ çš„è¡Œä¸ºå‡†åˆ™ã€‘
1. ç”¨æ¸©å’Œã€é¼“åŠ±çš„è¯­æ°”ï¼Œåƒæœ‹å‹ä¸€æ ·å’Œå®¶é•¿è¯´è¯
2. å›ç­”è¦å…·ä½“å®ç”¨ï¼Œä¸è¯´åºŸè¯
3. æ¶‰åŠåŒ»ç–—åˆ¤æ–­çš„é—®é¢˜ï¼Œå‘Šè¯‰å®¶é•¿"è¿™ä¸ªéœ€è¦å¤è¯Šæ—¶é—®åŒ»ç”Ÿï¼Œæˆ‘å¸®ä½ è®°ä¸‹æ¥"
4. å¦‚æœå®¶é•¿æè¿°ç´§æ€¥ç—‡çŠ¶ï¼ˆé«˜çƒ§è¶…è¿‡38.5åº¦æŒç»­24å°æ—¶ã€çªç„¶æ— æ³•å®Œæˆä¹‹å‰èƒ½åšçš„åŠ¨ä½œã€ä¼¤å£çº¢è‚¿ï¼‰ï¼Œç«‹å³å»ºè®®å°±åŒ»
5. æ¯æ¬¡å›å¤æ§åˆ¶åœ¨200å­—ä»¥å†…ï¼Œé™¤éé—®é¢˜éœ€è¦è¯¦ç»†è§£é‡Š
6. ä¸åšåŒ»ç–—è¯Šæ–­ï¼Œä¸å»ºè®®æ›´æ”¹åŒ»ç”Ÿåˆ¶å®šçš„æ–¹æ¡ˆ

ã€å›å¤è¯­è¨€ã€‘ï¼šä¸­æ–‡`;

      // æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼ˆGLM åŸç”Ÿæ”¯æŒ system roleï¼‰
      const messages = [
        { role: 'system', content: systemPrompt },
        // åŠ å…¥å¯¹è¯å†å²ï¼ˆæœ€è¿‘6æ¡ï¼‰
        ...conversationHistory.slice(-6),
        // å½“å‰ç”¨æˆ·æ¶ˆæ¯
        { role: 'user', content: userMessage }
      ];

      const response = await fetch(GLM_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GLM_API_KEY}`
        },
        body: JSON.stringify({
          model: 'glm-4-flash',
          messages,
          temperature: 0.7,
          max_tokens: 500
        })
      });

      if (!response.ok) throw new Error(`APIé”™è¯¯: ${response.status}`);
      const data = await response.json();
      return data.choices[0].message.content;
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // ç¦ç”¨è¾“å…¥
      messageInput.disabled = true;
      sendBtn.disabled = true;
      messageInput.value = '';

      // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
      renderMessage(message, true);
      
      // æ·»åŠ åˆ°å¯¹è¯å†å²
      conversationHistory.push({ role: 'user', content: message });

      // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Supabase
      saveChatLog('user', message)

      // æ˜¾ç¤ºæ€è€ƒä¸­
      renderThinking();

      try {
        // è°ƒç”¨ API
        const response = await sendToGLM(message);
        
        // ç§»é™¤æ€è€ƒä¸­
        removeThinking();
        
        // æ¸²æŸ“ AI å›å¤
        renderMessage(response, false);
        
        // æ·»åŠ åˆ°å¯¹è¯å†å²
        conversationHistory.push({ role: 'assistant', content: response });

        // ä¿å­˜ AI å›å¤åˆ° Supabase
        saveChatLog('assistant', response)
      } catch (error) {
        removeThinking();
        renderMessage('æŠ±æ­‰ï¼Œç½‘ç»œå‡ºäº†ç‚¹é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚', false);
        console.error('API Error:', error);
      }

      // å¯ç”¨è¾“å…¥
      messageInput.disabled = false;
      sendBtn.disabled = !messageInput.value.trim();
      messageInput.focus();
    }

    // äº‹ä»¶ç»‘å®š
    messageInput.addEventListener('input', () => {
      sendBtn.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // åˆå§‹åŒ–
    async function init() {
      const patient = await initPatientContext()
      if (!patient) return  // å·²è·³è½¬ï¼Œç»ˆæ­¢åç»­é€»è¾‘
      
      // åŠ è½½å†å²å¯¹è¯è®°å½•
      await loadChatHistory()
      
      // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
      if (conversationHistory.length === 0) {
        const welcomeMessage = `ä½ å¥½ï¼æˆ‘æ˜¯${patient.name}çš„åº·å¤åŠ©æ‰‹ ğŸŒŸ
æˆ‘äº†è§£${patient.name}ç›®å‰çš„åº·å¤è®¡åˆ’ï¼Œä½ å¯ä»¥é—®æˆ‘ï¼š

â€¢ ä»Šå¤©çš„è®­ç»ƒåŠ¨ä½œæ€ä¹ˆåšï¼Ÿ
â€¢ å­©å­ä¸é…åˆæ€ä¹ˆåŠï¼Ÿ
â€¢ è®­ç»ƒä¸­å‡ºç°ä»€ä¹ˆæƒ…å†µéœ€è¦æ³¨æ„ï¼Ÿ

æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿ`
        
        renderMessage(welcomeMessage, false)
      }
    }
    
    init()
  </script>
</body>
</html>