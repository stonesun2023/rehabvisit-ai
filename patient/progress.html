<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>RehabVisit AI Â· è¿›å±•è®°å½•</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    :root {
      --primary-color: #4A90D9;
      --primary-light: #EBF4FF;
      --success-color: #52C41A;
      --warning-color: #FAAD14;
      --danger-color: #FF4D4F;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --bg-page: #F5F7FA;
      --bg-card: #FFFFFF;
      --border-color: #E8ECF0;
      --border-radius: 12px;
      --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      padding-bottom: 70px;
    }

    /* é¡¶éƒ¨æ ‡é¢˜æ  */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }
    .nav-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* é€šç”¨å¡ç‰‡æ ·å¼ */
    .section-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      margin: 16px 20px;
      padding: 16px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    /* æ¨¡å—1ï¼šæ‰“å¡æ—¥å† */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .calendar-month {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .calendar-legend {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .legend-dot.done {
      background: var(--success-color);
    }
    .legend-dot.todo {
      border: 1px solid var(--border-color);
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .weekday {
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 4px 0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--text-primary);
      position: relative;
    }
    .calendar-day.other-month {
      color: var(--text-secondary);
      opacity: 0.4;
    }
    .calendar-day.today {
      font-weight: 600;
    }
    .calendar-day .dot {
      position: absolute;
      bottom: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .calendar-day .dot.done {
      background: var(--success-color);
    }
    .calendar-day .dot.partial {
      background: var(--warning-color);
    }

    /* æ¨¡å—2ï¼šè¿‘7å¤©å®Œæˆç‡ */
    .chart-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      height: 120px;
      padding: 0 8px;
    }
    .chart-bar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }
    .chart-bar {
      width: 24px;
      background: var(--primary-light);
      border-radius: 4px 4px 0 0;
      transition: height 0.3s ease;
      position: relative;
    }
    .chart-bar.has-data {
      background: var(--primary-color);
    }
    .chart-percent {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .chart-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    .chart-label.today {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* æ¨¡å—3ï¼šAIæ€»ç»“ */
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .refresh-btn {
      padding: 6px 12px;
      font-size: 13px;
      color: var(--primary-color);
      background: var(--primary-light);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .refresh-btn:active {
      transform: scale(0.95);
    }
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .summary-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .summary-loading {
      color: var(--text-secondary);
      font-size: 14px;
    }
    .summary-empty {
      color: var(--text-secondary);
      font-size: 14px;
      text-align: center;
      padding: 20px 0;
    }

    /* æ¨¡å—4ï¼šå†å²è®°å½•åˆ—è¡¨ */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-date {
      width: 70px;
      font-size: 12px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    .history-content {
      flex: 1;
    }
    .history-task {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }
    .history-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* åº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 20px;
    }
    .nav-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-decoration: none;
      font-size: 12px;
      color: var(--text-secondary);
      transition: color 0.3s ease;
    }
    .nav-tab.active {
      color: var(--primary-color);
    }
    .nav-tab-icon {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <!-- è¿›å±•è®°å½• -->
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <div class="top-nav">
    <div class="nav-title">è®­ç»ƒè¿›å±•</div>
  </div>

  <!-- æ¨¡å—1ï¼šæœ¬æœˆæ‰“å¡æ—¥å† -->
  <div class="section-card">
    <div class="calendar-header">
      <div class="calendar-month" id="calendarMonth"></div>
      <div class="calendar-legend">
        <div class="legend-item">
          <div class="legend-dot done"></div>
          <span>å·²æ‰“å¡</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot todo"></div>
          <span>æœªæ‰“å¡</span>
        </div>
      </div>
    </div>
    <div class="calendar-weekdays">
      <div class="weekday">æ—¥</div>
      <div class="weekday">ä¸€</div>
      <div class="weekday">äºŒ</div>
      <div class="weekday">ä¸‰</div>
      <div class="weekday">å››</div>
      <div class="weekday">äº”</div>
      <div class="weekday">å…­</div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>

  <!-- æ¨¡å—2ï¼šè¿‘7å¤©å®Œæˆç‡ -->
  <div class="section-card">
    <div class="section-title">è¿‘7å¤©å®Œæˆç‡</div>
    <div class="chart-container" id="chartContainer"></div>
  </div>

  <!-- æ¨¡å—3ï¼šæœ¬å‘¨AIæ€»ç»“ -->
  <div class="section-card">
    <div class="summary-header">
      <div class="section-title">æœ¬å‘¨è®­ç»ƒæ€»ç»“</div>
      <button class="refresh-btn" id="refreshBtn" onclick="generateSummary()">åˆ·æ–°</button>
    </div>
    <div class="summary-content" id="summaryContent">
      <div class="summary-empty">ç‚¹å‡»ã€Œåˆ·æ–°ã€ç”Ÿæˆæœ¬å‘¨æ€»ç»“</div>
    </div>
  </div>

  <!-- æ¨¡å—4ï¼šå†å²è®°å½•åˆ—è¡¨ -->
  <div class="section-card">
    <div class="section-title">å†å²è®°å½•</div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav">
    <a href="home.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ </span>
      <span>è®­ç»ƒ</span>
    </a>
    <a href="chat.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ’¬</span>
      <span>é—®é—®AI</span>
    </a>
    <a href="progress.html" class="nav-tab active">
      <span class="nav-tab-icon">ğŸ“ˆ</span>
      <span>è¿›å±•</span>
    </a>
  </div>

  <!-- å¼•å…¥å·¥å…·å‡½æ•° -->
  <script src="../js/utils.js"></script>
  <script>
    // ä»»åŠ¡æ€»æ•°ï¼ˆç”± module script ä» Supabase åŠ¨æ€è¯»å–ï¼‰
    let TOTAL_TASKS = 1;  // é»˜è®¤ä¸º 1ï¼Œé¿å…é™¤é›¶é”™è¯¯

    // GLM API é…ç½®
    const GLM_API_KEY = '27b0c3b4495d41a7abd38c5666e09665.7UmdjwqfPcaHfoZO';
    const GLM_API_URL = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';

    // è·å–æ‰€æœ‰æ‰“å¡è®°å½•ï¼ˆä» window.DB_LOGS è¯»å–ï¼Œç”± module script åŠ è½½ï¼‰
    function getAllLogs() {
      return window.DB_LOGS || [];
    }

    // æ¸²æŸ“å‡½æ•°åŒ…è£…å™¨ï¼ˆä¾› module script è°ƒç”¨ï¼‰
    function renderCalendarWithLogs(logs) { window.DB_LOGS = logs; renderCalendar(); }
    function renderChartWithLogs(logs) { window.DB_LOGS = logs; renderChart(); }
    function renderHistoryWithLogs(logs) { window.DB_LOGS = logs; renderHistory(); }

    // è·å–å·²æ‰“å¡æ—¥æœŸé›†åˆï¼ˆæ—¥æœŸ -> æ‰“å¡ä»»åŠ¡æ•°ï¼‰
    function getCompletedDates() {
      const logs = getAllLogs();
      const dateMap = {};
      logs.forEach(log => {
        const date = log.completed_at.slice(0, 10);
        dateMap[date] = (dateMap[date] || 0) + 1;
      });
      return dateMap;
    }

    // è·å–æœ¬å‘¨æ‰“å¡è®°å½•ï¼ˆç”¨æ—¥æœŸèŒƒå›´æ¯”è¾ƒï¼Œæ›´å¯é ï¼‰
    function getCurrentWeekLogs(logs) {
      const now = new Date();
      const dayOfWeek = now.getDay(); // 0=å‘¨æ—¥
      const monday = new Date(now);
      monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      monday.setHours(0, 0, 0, 0);
      
      return logs.filter(l => new Date(l.completed_at) >= monday);
    }

    // è·å–è¿‘7å¤©æ—¥æœŸæ•°ç»„
    function getLast7Days() {
      return Array.from({length: 7}, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (6 - i));
        return d.toISOString().slice(0, 10);
      });
    }

    // æ¨¡å—1ï¼šæ¸²æŸ“æ—¥å†
    function renderCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      
      // æ˜¾ç¤ºæœˆä»½
      document.getElementById('calendarMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
      
      // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startWeekday = firstDay.getDay();
      
      // è·å–æ‰“å¡æ•°æ®
      const dateMap = getCompletedDates();
      const today = now.toISOString().slice(0, 10);
      
      // ç”Ÿæˆæ—¥å†æ ¼å­
      const grid = document.getElementById('calendarGrid');
      let html = '';
      
      // ä¸Šæœˆç©ºç™½
      for (let i = 0; i < startWeekday; i++) {
        html += '<div class="calendar-day other-month"></div>';
      }
      
      // å½“æœˆæ—¥æœŸ
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const taskCount = dateMap[dateStr] || 0;
        const isToday = dateStr === today;
        
        let dotHtml = '';
        if (taskCount > 0) {
          const dotClass = taskCount >= TOTAL_TASKS ? 'done' : 'partial';
          dotHtml = `<div class="dot ${dotClass}"></div>`;
        }
        
        html += `
          <div class="calendar-day ${isToday ? 'today' : ''}">
            ${day}
            ${dotHtml}
          </div>
        `;
      }
      
      grid.innerHTML = html;
    }

    // æ¨¡å—2ï¼šæ¸²æŸ“å®Œæˆç‡å›¾è¡¨
    function renderChart() {
      const container = document.getElementById('chartContainer');
      const dateMap = getCompletedDates();
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const last7Days = getLast7Days();
      const todayStr = new Date().toISOString().slice(0, 10);
      
      let html = '';
      
      last7Days.forEach((dateStr, index) => {
        const taskCount = dateMap[dateStr] || 0;
        const percent = Math.round((taskCount / TOTAL_TASKS) * 100);
        const isToday = dateStr === todayStr;
        const date = new Date(dateStr);
        
        html += `
          <div class="chart-bar-wrapper">
            <div class="chart-percent">${percent}%</div>
            <div class="chart-bar ${taskCount > 0 ? 'has-data' : ''}" style="height: ${Math.max(percent, 4)}%"></div>
            <div class="chart-label ${isToday ? 'today' : ''}">å‘¨${weekdays[date.getDay()]}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // æ¨¡å—3ï¼šç”ŸæˆAIæ€»ç»“
    async function generateSummary() {
      const btn = document.getElementById('refreshBtn');
      const content = document.getElementById('summaryContent');
      
      btn.disabled = true;
      content.innerHTML = '<div class="summary-loading">æ­£åœ¨ç”Ÿæˆ...</div>';
      
      try {
        const logs = getAllLogs();
        const weekLogs = getCurrentWeekLogs(logs);
        
        if (weekLogs.length === 0) {
          content.innerHTML = '<div class="summary-empty">æœ¬å‘¨è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</div>';
          btn.disabled = false;
          return;
        }
        
        const difficultyText = ['', 'è½»æ¾', 'æ­£å¸¸', 'æœ‰ç‚¹åƒåŠ›'];
        const summary = weekLogs.map(l =>
          `${l.completed_at.slice(0, 10)} å®Œæˆã€Œ${l.task_name}ã€ï¼Œå›°éš¾åº¦ï¼š${difficultyText[l.difficulty]}ï¼Œå¤‡æ³¨ï¼š${l.note || 'æ— '}`
        ).join('\n');
        
        const prompt = `ä»¥ä¸‹æ˜¯ä¸€ä½å„¿ç«¥åº·å¤æ‚£è€…æœ¬å‘¨çš„è®­ç»ƒæ‰“å¡è®°å½•ï¼š
${summary}

è¯·ç”¨æ¸©å’Œã€é¼“åŠ±çš„è¯­æ°”ï¼Œç»™å®¶é•¿å†™ä¸€æ®µ100å­—ä»¥å†…çš„æœ¬å‘¨è®­ç»ƒæ€»ç»“ï¼ŒæŒ‡å‡ºåšæŒå¾—å¥½çš„åœ°æ–¹ï¼Œä»¥åŠéœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚ä¸è¦åšåŒ»ç–—è¯Šæ–­ï¼Œä¸è¦å»ºè®®æ›´æ”¹è®­ç»ƒæ–¹æ¡ˆã€‚`;

        const response = await fetch(GLM_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GLM_API_KEY}`
          },
          body: JSON.stringify({
            model: 'glm-4-flash',
            messages: [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åº·å¤åŒ»å­¦ç§‘AIåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºæ‚£è€…å®¶é•¿æä¾›æ”¯æŒã€‚ä½ çš„å›å¤è¦æ¸©å’Œã€é¼“åŠ±ï¼Œä¸åšåŒ»ç–—è¯Šæ–­ã€‚' },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 300
          })
        });

        if (!response.ok) throw new Error(`APIé”™è¯¯: ${response.status}`);
        const data = await response.json();
        const result = data.choices[0].message.content;
        
        content.innerHTML = result;
      } catch (error) {
        content.innerHTML = '<div class="summary-empty">ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        console.error('API Error:', error);
      }
      
      btn.disabled = false;
    }

    // æ¨¡å—4ï¼šæ¸²æŸ“å†å²è®°å½•
    function renderHistory() {
      const container = document.getElementById('historyList');
      const logs = getAllLogs();
      
      // æŒ‰æ—¶é—´å€’åºï¼Œå–æœ€è¿‘20æ¡
      const recentLogs = logs.sort((a, b) => 
        new Date(b.completed_at) - new Date(a.completed_at)
      ).slice(0, 20);
      
      if (recentLogs.length === 0) {
        container.innerHTML = '<div class="history-empty">è¿˜æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œå»å®Œæˆä»Šå¤©çš„è®­ç»ƒå§ ğŸ’ª</div>';
        return;
      }
      
      const difficultyEmoji = { 1: 'ğŸ˜Š', 2: 'ğŸ˜', 3: 'ğŸ˜“' };
      
      let html = '';
      recentLogs.forEach(log => {
        const date = log.completed_at.slice(0, 10);
        const time = log.completed_at.slice(11, 16);
        html += `
          <div class="history-item">
            <div class="history-date">${date}<br>${time}</div>
            <div class="history-content">
              <div class="history-task">${log.task_name} ${difficultyEmoji[log.difficulty]}</div>
              ${log.note ? `<div class="history-note">${log.note}</div>` : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // åˆå§‹åŒ–ç”± module script è§¦å‘
  </script>

  <script type="module">
    import { supabase } from '../js/supabase-client.js'
    import { ensurePatientSession } from '../js/auth.js'

    async function loadAndRender() {
      // ä½¿ç”¨ ensurePatientSession è·å–æ‚£è€…ä¿¡æ¯ï¼ˆè‡ªåŠ¨æ¢å¤ sessionStorageï¼‰
      const patient = await ensurePatientSession()
      if (!patient) return  // å·²è·³è½¬ï¼Œç»ˆæ­¢åç»­é€»è¾‘

      // æ‹‰å–ä»»åŠ¡æ€»æ•°ï¼ˆç”¨äºè®¡ç®—å®Œæˆç‡ï¼‰
      try {
        const { data: tasks, error: taskError } = await supabase
          .from('daily_tasks')
          .select('id')
          .eq('patient_id', patient.id)
        
        if (!taskError && tasks && tasks.length > 0) {
          TOTAL_TASKS = tasks.length
        } else {
          TOTAL_TASKS = 1  // å›é€€ä¸º 1ï¼Œé¿å…é™¤é›¶é”™è¯¯
        }
      } catch (err) {
        TOTAL_TASKS = 1  // æŸ¥è¯¢å‡ºé”™ä¹Ÿå›é€€ä¸º 1
      }

      // æ‹‰å–æœ€è¿‘30å¤©æ‰“å¡è®°å½•
      const thirtyDaysAgo = new Date()
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

      const { data: logs } = await supabase
        .from('task_logs')
        .select('*, daily_tasks(task_name)')
        .eq('patient_id', patient.id)
        .gte('completed_at', thirtyDaysAgo.toISOString())
        .order('completed_at', { ascending: false })

      // æ ¼å¼åŒ–æ•°æ®ï¼Œå…¼å®¹åŸæœ‰æ¸²æŸ“å‡½æ•°çš„å­—æ®µ
      const formatted = (logs || []).map(l => ({
        ...l,
        task_name: l.daily_tasks?.task_name || 'è®­ç»ƒä»»åŠ¡',
        difficulty: l.difficulty_level,
        completed_at: l.completed_at
      }))

      // æŠŠæ•°æ®æŒ‚åˆ° windowï¼Œè®©æ™®é€š script çš„å‡½æ•°èƒ½è®¿é—®
      window.DB_LOGS = formatted
      renderCalendarWithLogs(formatted)
      renderChartWithLogs(formatted)
      renderHistoryWithLogs(formatted)
    }

    loadAndRender()
  </script>
</body>
</html>
