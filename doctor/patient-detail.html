<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>RehabVisit AI Â· æ‚£è€…è¯¦æƒ…</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    :root {
      --primary-color: #4A90D9;
      --primary-light: #EBF4FF;
      --success-color: #52C41A;
      --warning-color: #FAAD14;
      --danger-color: #FF4D4F;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --bg-page: #F5F7FA;
      --bg-card: #FFFFFF;
      --border-color: #E8ECF0;
      --border-radius: 12px;
      --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      padding-bottom: 20px;
    }

    /* åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }
    .back-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-primary);
      text-decoration: none;
      margin-right: 8px;
    }
    .nav-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* åŒºåŸŸäºŒï¼šåŸºæœ¬ä¿¡æ¯å¡ç‰‡ */
    .info-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      margin: 16px 20px;
      padding: 16px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .info-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    /* åŒºåŸŸä¸‰ï¼šTab åˆ‡æ¢ */
    .tab-container {
      margin: 0 20px;
    }
    .tab-header {
      display: flex;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 4px;
      box-shadow: var(--shadow-card);
    }
    .tab-btn {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      background: transparent;
      border: none;
    }
    .tab-btn.active {
      background: var(--primary-color);
      color: #fff;
    }
    .tab-content {
      display: none;
      margin-top: 16px;
    }
    .tab-content.active {
      display: block;
    }

    /* åŒºåŸŸå››ï¼šè®­ç»ƒè®¡åˆ’ */
    .plan-section {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      padding: 16px;
      margin-bottom: 16px;
    }
    .plan-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }
    .plan-textarea {
      width: 100%;
      min-height: 150px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-page);
      resize: vertical;
      box-sizing: border-box;
    }
    .plan-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .plan-display {
      width: 100%;
      min-height: 120px;
      background: var(--bg-page);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      color: var(--text-primary);
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .plan-display.empty {
      color: var(--text-secondary);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .btn {
      flex: 1;
      height: 44px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-primary {
      background: var(--primary-color);
      color: #fff;
    }
    .btn-primary:disabled {
      background: var(--border-color);
      cursor: not-allowed;
    }
    .btn-success {
      background: var(--success-color);
      color: #fff;
    }
    .btn-secondary {
      background: var(--bg-page);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .error-message {
      font-size: 13px;
      color: var(--danger-color);
      margin-top: 8px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    .success-message {
      font-size: 13px;
      color: var(--success-color);
      margin-top: 8px;
      display: none;
    }
    .success-message.show {
      display: block;
    }

    /* å ä½å†…å®¹ */
    .placeholder {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* ä»»åŠ¡ç®¡ç† */
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-page);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .task-item-info { flex: 1; }
    .task-item-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .task-item-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .task-item-freq { font-size: 12px; color: var(--primary-color); margin-top: 2px; }
    .task-delete-btn {
      width: 28px; height: 28px;
      border: none; background: none;
      color: var(--danger-color);
      font-size: 18px; cursor: pointer;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <!-- åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <a href="dashboard.html" class="back-btn">â†</a>
    <div class="nav-title" id="patientName">åŠ è½½ä¸­...</div>
  </div>

  <!-- åŒºåŸŸäºŒï¼šåŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
  <div class="info-card" id="infoCard">
    <div class="info-row">
      <span class="info-label">å§“å</span>
      <span class="info-value" id="infoName">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">å¹´é¾„</span>
      <span class="info-value" id="infoAge">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">è¯Šæ–­</span>
      <span class="info-value" id="infoDiagnosis">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">è”ç³»æ–¹å¼</span>
      <span class="info-value" id="infoContact">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">å»ºæ¡£æ—¶é—´</span>
      <span class="info-value" id="infoCreatedAt">-</span>
    </div>
  </div>

  <!-- åŒºåŸŸä¸‰ï¼šTab åˆ‡æ¢ -->
  <div class="tab-container">
    <div class="tab-header">
      <button class="tab-btn active" data-tab="plan">è®­ç»ƒè®¡åˆ’</button>
      <button class="tab-btn" data-tab="logs">æ‰“å¡è®°å½•</button>
    </div>

    <!-- Tab 1ï¼šè®­ç»ƒè®¡åˆ’ -->
    <div class="tab-content active" id="tabPlan">
      <!-- åŒ»ç”Ÿä¸“ä¸šç‰ˆ -->
      <div class="plan-section">
        <div class="plan-title">ğŸ“ åŒ»ç”Ÿä¸“ä¸šç‰ˆ</div>
        <textarea class="plan-textarea" id="professionalContent" placeholder="è¯·è¾“å…¥ä¸“ä¸šåº·å¤è®­ç»ƒè®¡åˆ’..."></textarea>
        <div class="error-message" id="professionalError"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="saveProfessionalBtn">ä¿å­˜è®¡åˆ’</button>
        </div>
      </div>

      <!-- å®¶é•¿é€šä¿—ç‰ˆ -->
      <div class="plan-section">
        <div class="plan-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿é€šä¿—ç‰ˆ</div>
        <div class="plan-display empty" id="familyDisplay">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼ŒAI å°†è‡ªåŠ¨ç”Ÿæˆå®¶é•¿ç‰ˆ</div>
        <div class="error-message" id="familyError"></div>
        <div class="success-message" id="familySuccess"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" id="generateFamilyBtn">âœ¨ AI ä¸€é”®ç”Ÿæˆå®¶é•¿ç‰ˆ</button>
          <button class="btn btn-success" id="confirmFamilyBtn" style="display:none">âœ… ç¡®è®¤å¹¶ä¿å­˜</button>
        </div>
      </div>

      <!-- æ¯æ—¥ä»»åŠ¡ç®¡ç† -->
      <div class="plan-section" id="taskSection">
        <div class="plan-title">ğŸ“‹ æ¯æ—¥è®­ç»ƒä»»åŠ¡</div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div id="taskList"></div>

        <!-- æ‰‹åŠ¨æ·»åŠ è¡¨å• -->
        <div id="addTaskForm" style="margin-top:12px;">
          <input type="text" id="taskName" placeholder="ä»»åŠ¡åç§°ï¼ˆå¦‚ï¼šè…¿éƒ¨æ‹‰ä¼¸ï¼‰" 
            style="width:100%;height:44px;border:1px solid var(--border-color);border-radius:8px;padding:0 12px;font-size:14px;box-sizing:border-box;margin-bottom:8px;background:var(--bg-page);">
          <input type="text" id="taskDesc" placeholder="æè¿°ï¼ˆå¦‚ï¼šåŒä¾§è…“è‚ è‚Œç‰µä¼¸ï¼Œä¿æŒ30ç§’ï¼‰"
            style="width:100%;height:44px;border:1px solid var(--border-color);border-radius:8px;padding:0 12px;font-size:14px;box-sizing:border-box;margin-bottom:8px;background:var(--bg-page);">
          <input type="text" id="taskFreq" placeholder="é¢‘æ¬¡ï¼ˆå¦‚ï¼šæ¯å¤©2æ¬¡ï¼‰"
            style="width:100%;height:44px;border:1px solid var(--border-color);border-radius:8px;padding:0 12px;font-size:14px;box-sizing:border-box;margin-bottom:12px;background:var(--bg-page);">
          <div class="btn-group">
            <button class="btn btn-secondary" id="addTaskBtn">ï¼‹ æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡</button>
            <button class="btn btn-primary" id="aiSplitBtn">ğŸ¤– AI æ‹†è§£ä»»åŠ¡</button>
          </div>
        </div>
        <div class="error-message" id="taskError"></div>
        <div class="success-message" id="taskSuccess"></div>
      </div>
    </div>

    <!-- Tab 2ï¼šæ‰“å¡è®°å½• -->
    <div class="tab-content" id="tabLogs">
      <div class="plan-section">
        <div class="plan-title">ğŸ“Š å†å²æ‰“å¡è®°å½•</div>
        <div id="logsList">
          <div style="color:var(--text-secondary);font-size:13px;text-align:center;padding:16px 0;">ç‚¹å‡»ã€Œæ‰“å¡è®°å½•ã€Tab åŠ è½½æ•°æ®...</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../js/supabase-client.js'
    import { callGLM } from '../js/ai.js'

    // ä» URL è·å–æ‚£è€… id
    const patientId = new URLSearchParams(window.location.search).get('id')
    
    // å½“å‰è®¡åˆ’ IDï¼ˆç”¨äºæ›´æ–°ï¼‰
    let currentPlanId = null
    let generatedFamilyContent = null

    // åˆå§‹åŒ–
    async function init() {
      if (!patientId) {
        window.location.href = './dashboard.html'
        return
      }

      // éªŒè¯ç™»å½•
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        window.location.href = '../index.html'
        return
      }

      // æ‹‰å–æ‚£è€…ä¿¡æ¯
      const { data: patient, error: patientError } = await supabase
        .from('patients')
        .select('*')
        .eq('id', patientId)
        .single()

      if (patientError || !patient) {
        alert('æ‚£è€…ä¸å­˜åœ¨')
        window.location.href = './dashboard.html'
        return
      }

      renderPatientInfo(patient)

      // æ‹‰å–å·²æœ‰è®¡åˆ’
      const { data: plan } = await supabase
        .from('rehab_plans')
        .select('*')
        .eq('patient_id', patientId)
        .order('created_at', { ascending: false })
        .limit(1)
        .single()

      if (plan) {
        currentPlanId = plan.id
        document.getElementById('professionalContent').value = plan.professional_content || ''
        if (plan.family_content) {
          document.getElementById('familyDisplay').textContent = plan.family_content
          document.getElementById('familyDisplay').classList.remove('empty')
          generatedFamilyContent = plan.family_content
        }
      }
    }

    // æ¸²æŸ“æ‚£è€…ä¿¡æ¯
    function renderPatientInfo(patient) {
      document.getElementById('patientName').textContent = patient.name
      document.getElementById('infoName').textContent = patient.name
      document.getElementById('infoAge').textContent = patient.age ? `${patient.age}å²` : '-'
      document.getElementById('infoDiagnosis').textContent = patient.diagnosis || '-'
      document.getElementById('infoContact').textContent = patient.contact || '-'
      document.getElementById('infoCreatedAt').textContent = formatDate(patient.created_at)
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      if (!dateStr) return '-'
      const d = new Date(dateStr)
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
    }

    // Tab åˆ‡æ¢
    let logsLoaded = false  // æ ‡è®°æ‰“å¡è®°å½•æ˜¯å¦å·²åŠ è½½
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'))
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
        btn.classList.add('active')
        document.getElementById('tab' + btn.dataset.tab.charAt(0).toUpperCase() + btn.dataset.tab.slice(1)).classList.add('active')
        
        // åˆ‡æ¢åˆ°æ‰“å¡è®°å½• Tab æ—¶åŠ è½½æ•°æ®
        if (btn.dataset.tab === 'logs' && !logsLoaded) {
          loadCheckinLogs()
        }
      })
    })

    // åŠ è½½æ‰“å¡è®°å½•
    async function loadCheckinLogs() {
      const container = document.getElementById('logsList')
      container.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;text-align:center;padding:16px 0;">åŠ è½½ä¸­...</div>'

      try {
        const { data: logs, error } = await supabase
          .from('task_logs')
          .select('*, daily_tasks(task_name)')
          .eq('patient_id', patientId)
          .order('completed_at', { ascending: false })
          .limit(100)

        if (error) throw error

        logsLoaded = true

        if (!logs || logs.length === 0) {
          container.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;text-align:center;padding:16px 0;">æš‚æ— æ‰“å¡è®°å½•</div>'
          return
        }

        const difficultyEmoji = { 1: 'ğŸ˜Š è½»æ¾', 2: 'ğŸ˜ æ­£å¸¸', 3: 'ğŸ˜“ åƒåŠ›' }

        container.innerHTML = logs.map(log => {
          const date = log.completed_at.slice(0, 10)
          const time = log.completed_at.slice(11, 16)
          const taskName = log.daily_tasks?.task_name || 'æœªçŸ¥ä»»åŠ¡'
          const difficulty = difficultyEmoji[log.difficulty_level] || 'æœªè¯„åˆ†'
          const note = log.note || ''

          return `
            <div class="task-item" style="flex-direction:column;align-items:flex-start;">
              <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:4px;">
                <span class="task-item-name">${taskName}</span>
                <span style="font-size:12px;color:var(--text-secondary);">${date} ${time}</span>
              </div>
              <div style="font-size:12px;color:var(--text-secondary);">
                éš¾åº¦ï¼š${difficulty}
                ${note ? ` Â· å¤‡æ³¨ï¼š${note}` : ''}
              </div>
            </div>
          `
        }).join('')
      } catch (err) {
        container.innerHTML = `<div style="color:var(--danger-color);font-size:13px;text-align:center;padding:16px 0;">åŠ è½½å¤±è´¥ï¼š${err.message}</div>`
      }
    }

    // ä¿å­˜ä¸“ä¸šç‰ˆè®¡åˆ’
    document.getElementById('saveProfessionalBtn').addEventListener('click', async () => {
      const content = document.getElementById('professionalContent').value.trim()
      const errorEl = document.getElementById('professionalError')

      if (!content) {
        errorEl.textContent = 'è¯·è¾“å…¥ä¸“ä¸šåº·å¤è®¡åˆ’'
        errorEl.classList.add('show')
        return
      }

      errorEl.classList.remove('show')
      const btn = document.getElementById('saveProfessionalBtn')
      btn.disabled = true
      btn.textContent = 'ä¿å­˜ä¸­...'

      try {
        if (currentPlanId) {
          // æ›´æ–°
          const { error } = await supabase
            .from('rehab_plans')
            .update({ professional_content: content, updated_at: new Date().toISOString() })
            .eq('id', currentPlanId)
          if (error) throw error
        } else {
          // æ–°å¢
          const { data: { session } } = await supabase.auth.getSession()
          const { error } = await supabase
            .from('rehab_plans')
            .insert({
              patient_id: patientId,
              doctor_id: session.user.id,
              professional_content: content
            })
          if (error) throw error
        }

        btn.textContent = 'å·²ä¿å­˜ âœ“'
        setTimeout(() => {
          btn.textContent = 'ä¿å­˜è®¡åˆ’'
          btn.disabled = false
        }, 2000)
      } catch (err) {
        errorEl.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + err.message
        errorEl.classList.add('show')
        btn.textContent = 'ä¿å­˜è®¡åˆ’'
        btn.disabled = false
      }
    })

    // AI ç”Ÿæˆå®¶é•¿ç‰ˆ
    document.getElementById('generateFamilyBtn').addEventListener('click', async () => {
      const professional = document.getElementById('professionalContent').value.trim()
      const errorEl = document.getElementById('familyError')
      const successEl = document.getElementById('familySuccess')

      if (!professional) {
        errorEl.textContent = 'è¯·å…ˆå¡«å†™ä¸“ä¸šç‰ˆè®¡åˆ’'
        errorEl.classList.add('show')
        return
      }

      errorEl.classList.remove('show')
      successEl.classList.remove('show')

      const btn = document.getElementById('generateFamilyBtn')
      btn.disabled = true
      btn.textContent = 'ç”Ÿæˆä¸­...'

      const display = document.getElementById('familyDisplay')
      display.textContent = 'AI æ­£åœ¨ç”Ÿæˆå®¶é•¿ç‰ˆï¼Œè¯·ç¨å€™...'
      display.classList.remove('empty')

      try {
        const result = await callGLM([
          { role: 'system', content: 'ä½ æ˜¯ä¸€ååº·å¤ç§‘åŒ»ç”ŸåŠ©æ‰‹ï¼Œè¯·å°†ä¸“ä¸šçš„åº·å¤è®­ç»ƒè®¡åˆ’æ”¹å†™æˆå®¶é•¿èƒ½çœ‹æ‡‚çš„é€šä¿—ç‰ˆæœ¬ï¼Œè¯­è¨€æ¸©å’Œã€ç®€æ´ã€é¼“åŠ±æ€§å¼ºï¼Œé¿å…ä¸“ä¸šæœ¯è¯­ï¼Œæ¯ä¸ªè®­ç»ƒé¡¹ç›®è¯´æ˜è¦ç‚¹å’Œæ³¨æ„äº‹é¡¹ã€‚' },
          { role: 'user', content: `è¯·å°†ä»¥ä¸‹ä¸“ä¸šåº·å¤è®¡åˆ’æ”¹å†™ä¸ºå®¶é•¿ç‰ˆï¼š\n${professional}` }
        ])

        generatedFamilyContent = result
        display.textContent = result
        document.getElementById('confirmFamilyBtn').style.display = 'block'
        btn.textContent = 'âœ¨ é‡æ–°ç”Ÿæˆ'
        btn.disabled = false
      } catch (err) {
        errorEl.textContent = 'ç”Ÿæˆå¤±è´¥ï¼š' + err.message
        errorEl.classList.add('show')
        display.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•'
        btn.textContent = 'âœ¨ AI ä¸€é”®ç”Ÿæˆå®¶é•¿ç‰ˆ'
        btn.disabled = false
      }
    })

    // ç¡®è®¤å¹¶ä¿å­˜å®¶é•¿ç‰ˆ
    document.getElementById('confirmFamilyBtn').addEventListener('click', async () => {
      if (!generatedFamilyContent) return

      const confirmed = confirm('âš ï¸ è¯·ç¡®è®¤åŒ»ç–—å†…å®¹æ— è¯¯åä¿å­˜\n\nAI ç”Ÿæˆçš„å†…å®¹éœ€è¦æ‚¨å®¡æ ¸ç¡®è®¤ï¼Œç¡®è®¤åå°†å±•ç¤ºç»™å®¶é•¿ã€‚')
      if (!confirmed) return

      const btn = document.getElementById('confirmFamilyBtn')
      btn.disabled = true
      btn.textContent = 'ä¿å­˜ä¸­...'

      try {
        const { data: { session } } = await supabase.auth.getSession()

        if (currentPlanId) {
          const { error } = await supabase
            .from('rehab_plans')
            .update({ 
              family_content: generatedFamilyContent, 
              is_approved: true,
              updated_at: new Date().toISOString() 
            })
            .eq('id', currentPlanId)
          if (error) throw error
        } else {
          const { error } = await supabase
            .from('rehab_plans')
            .insert({
              patient_id: patientId,
              doctor_id: session.user.id,
              professional_content: document.getElementById('professionalContent').value,
              family_content: generatedFamilyContent,
              is_approved: true
            })
          if (error) throw error
        }

        document.getElementById('familySuccess').textContent = 'å·²ä¿å­˜å¹¶å‘å¸ƒç»™å®¶é•¿ âœ“'
        document.getElementById('familySuccess').classList.add('show')
        btn.textContent = 'âœ… å·²ç¡®è®¤ä¿å­˜'
      } catch (err) {
        document.getElementById('familyError').textContent = 'ä¿å­˜å¤±è´¥ï¼š' + err.message
        document.getElementById('familyError').classList.add('show')
        btn.textContent = 'âœ… ç¡®è®¤å¹¶ä¿å­˜'
        btn.disabled = false
      }
    })

    // åŠ è½½å¹¶æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    async function loadTasks() {
      const { data: tasks } = await supabase
        .from('daily_tasks')
        .select('*')
        .eq('patient_id', patientId)
        .order('sort_order', { ascending: true })
      renderTaskList(tasks || [])
    }

    function renderTaskList(tasks) {
      const container = document.getElementById('taskList')
      if (tasks.length === 0) {
        container.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;text-align:center;padding:16px 0;">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ æˆ– AI æ‹†è§£</div>'
        return
      }
      container.innerHTML = tasks.map(t => `
        <div class="task-item" data-id="${t.id}">
          <div class="task-item-info">
            <div class="task-item-name">${t.task_name}</div>
            ${t.description ? `<div class="task-item-desc">${t.description}</div>` : ''}
            ${t.frequency ? `<div class="task-item-freq">ğŸ“… ${t.frequency}</div>` : ''}
          </div>
          <button class="task-delete-btn" onclick="deleteTask('${t.id}')">Ã—</button>
        </div>
      `).join('')
    }

    // æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡
    document.getElementById('addTaskBtn').addEventListener('click', async () => {
      const name = document.getElementById('taskName').value.trim()
      const desc = document.getElementById('taskDesc').value.trim()
      const freq = document.getElementById('taskFreq').value.trim()
      const errorEl = document.getElementById('taskError')

      if (!name) {
        errorEl.textContent = 'è¯·è¾“å…¥ä»»åŠ¡åç§°'
        errorEl.classList.add('show')
        return
      }
      errorEl.classList.remove('show')

      const { data: tasks } = await supabase
        .from('daily_tasks').select('sort_order').eq('patient_id', patientId)
        .order('sort_order', { ascending: false }).limit(1)
      const nextOrder = tasks?.[0]?.sort_order + 1 || 0

      const { error } = await supabase.from('daily_tasks').insert({
        patient_id: patientId,
        plan_id: currentPlanId,
        task_name: name,
        description: desc,
        frequency: freq,
        sort_order: nextOrder
      })

      if (error) {
        errorEl.textContent = 'æ·»åŠ å¤±è´¥ï¼š' + error.message
        errorEl.classList.add('show')
        return
      }

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('taskName').value = ''
      document.getElementById('taskDesc').value = ''
      document.getElementById('taskFreq').value = ''
      loadTasks()
    })

    // AI æ‹†è§£ä»»åŠ¡
    document.getElementById('aiSplitBtn').addEventListener('click', async () => {
      const professional = document.getElementById('professionalContent').value.trim()
      const errorEl = document.getElementById('taskError')
      const successEl = document.getElementById('taskSuccess')

      if (!professional) {
        errorEl.textContent = 'è¯·å…ˆå¡«å†™å¹¶ä¿å­˜ä¸“ä¸šç‰ˆè®¡åˆ’'
        errorEl.classList.add('show')
        return
      }

      errorEl.classList.remove('show')
      successEl.classList.remove('show')

      const btn = document.getElementById('aiSplitBtn')
      btn.disabled = true
      btn.textContent = 'æ‹†è§£ä¸­...'

      try {
        const result = await callGLM([
          { 
            role: 'system', 
            content: 'ä½ æ˜¯åº·å¤åŒ»å­¦ç§‘AIåŠ©æ‰‹ã€‚è¯·å°†åº·å¤è®¡åˆ’æ‹†è§£ä¸ºæ¯æ—¥è®­ç»ƒä»»åŠ¡åˆ—è¡¨ï¼Œä¸¥æ ¼æŒ‰JSONæ ¼å¼è¿”å›ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€‚æ ¼å¼ï¼š[{"task_name":"ä»»åŠ¡å","description":"å…·ä½“æè¿°","frequency":"é¢‘æ¬¡"}]' 
          },
          { role: 'user', content: `è¯·å°†ä»¥ä¸‹åº·å¤è®¡åˆ’æ‹†è§£ä¸ºæ¯æ—¥ä»»åŠ¡åˆ—è¡¨ï¼š\n${professional}` }
        ])

        // è§£æJSON
        const jsonStr = result.replace(/```json|```/g, '').trim()
        const tasks = JSON.parse(jsonStr)

        if (!Array.isArray(tasks) || tasks.length === 0) throw new Error('AI è¿”å›æ ¼å¼å¼‚å¸¸')

        // ç¡®è®¤åæ‰¹é‡æ’å…¥
        const confirmed = confirm(`AI æ‹†è§£å‡º ${tasks.length} ä¸ªä»»åŠ¡ï¼Œç¡®è®¤åå°†è¦†ç›–ç°æœ‰ä»»åŠ¡åˆ—è¡¨ï¼š\n\n${tasks.map(t => `â€¢ ${t.task_name}ï¼š${t.frequency}`).join('\n')}\n\nç¡®è®¤ä¿å­˜ï¼Ÿ`)
        if (!confirmed) {
          btn.textContent = 'ğŸ¤– AI æ‹†è§£ä»»åŠ¡'
          btn.disabled = false
          return
        }

        // åˆ é™¤æ—§ä»»åŠ¡
        await supabase.from('daily_tasks').delete().eq('patient_id', patientId)

        // æ’å…¥æ–°ä»»åŠ¡
        const inserts = tasks.map((t, i) => ({
          patient_id: patientId,
          plan_id: currentPlanId,
          task_name: t.task_name,
          description: t.description,
          frequency: t.frequency,
          sort_order: i
        }))
        const { error } = await supabase.from('daily_tasks').insert(inserts)
        if (error) throw error

        successEl.textContent = `å·²æˆåŠŸå¯¼å…¥ ${tasks.length} ä¸ªè®­ç»ƒä»»åŠ¡ âœ“`
        successEl.classList.add('show')
        loadTasks()
      } catch (err) {
        errorEl.textContent = 'AIæ‹†è§£å¤±è´¥ï¼š' + err.message
        errorEl.classList.add('show')
      }

      btn.textContent = 'ğŸ¤– AI æ‹†è§£ä»»åŠ¡'
      btn.disabled = false
    })

    // åˆ é™¤ä»»åŠ¡
    window.deleteTask = async (taskId) => {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return
      await supabase.from('daily_tasks').delete().eq('id', taskId)
      loadTasks()
    }

    // åˆå§‹åŒ–
    init()
    loadTasks()
  </script>
</body>
</html>