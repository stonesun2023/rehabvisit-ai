<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>RehabVisit AI Â· åŒ»ç”Ÿçœ‹æ¿</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    :root {
      --primary-color: #4A90D9;
      --primary-light: #EBF4FF;
      --success-color: #52C41A;
      --warning-color: #FAAD14;
      --danger-color: #FF4D4F;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --bg-page: #F5F7FA;
      --bg-card: #FFFFFF;
      --border-color: #E8ECF0;
      --border-radius: 12px;
      --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      padding-bottom: 80px;
    }

    /* åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }
    .nav-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .nav-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-color);
      cursor: pointer;
    }

    /* åŒºåŸŸäºŒï¼šç»Ÿè®¡æ‘˜è¦å¡ç‰‡ */
    .stats-container {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
    }
    .stat-card {
      flex: 1;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* åŒºåŸŸä¸‰ï¼šæ‚£è€…åˆ—è¡¨ */
    .section-header {
      padding: 0 20px;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .patient-list {
      padding: 0 20px;
    }
    .patient-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-card);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .patient-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .patient-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .patient-age {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 8px;
    }
    .patient-diagnosis {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .patient-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .last-checkin {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .progress-mini {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-mini-bar {
      width: 60px;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-mini-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 3px;
    }
    .progress-mini-text {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .empty-text {
      font-size: 14px;
    }

    /* åŒºåŸŸå››ï¼šæ‚¬æµ®æ·»åŠ æŒ‰é’® */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-color);
      color: #fff;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(74, 144, 217, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(74, 144, 217, 0.5);
    }
  </style>
</head>
<body>
  <!-- åŒºåŸŸä¸€ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <div class="nav-left">
      <div class="nav-title">åº·å¤éšè®¿ AI</div>
      <div class="nav-subtitle">åŒ»ç”Ÿç«¯</div>
    </div>
    <div class="avatar" id="avatarBtn" title="é€€å‡ºç™»å½•">åŒ»</div>
  </div>

  <!-- åŒºåŸŸäºŒï¼šç»Ÿè®¡æ‘˜è¦å¡ç‰‡ -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-value" id="totalPatients">0</div>
      <div class="stat-label">æ‚£è€…æ€»æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="weekCheckins">-</div>
      <div class="stat-label">æœ¬å‘¨å·²æ‰“å¡</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="pendingReview">-</div>
      <div class="stat-label">å¾…æŸ¥çœ‹è®°å½•</div>
    </div>
  </div>

  <!-- åŒºåŸŸä¸‰ï¼šå¼‚å¸¸æé†’åŒºå— -->
  <div id="flaggedSection" style="margin:16px 20px;display:none;">
    <div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:12px;padding:16px;">
      <div style="font-size:15px;font-weight:600;color:#856404;margin-bottom:12px;">
        âš ï¸ éœ€å…³æ³¨çš„å¯¹è¯ï¼ˆ<span id="flaggedCount">0</span>ï¼‰
      </div>
      <div id="flaggedList"></div>
    </div>
  </div>

  <!-- åŒºåŸŸå››ï¼šæ‚£è€…åˆ—è¡¨ -->
  <div class="section-header">
    <div class="section-title">æˆ‘çš„æ‚£è€…</div>
  </div>
  <div style="margin:0 20px 12px;">
    <input id="searchInput" type="text" placeholder="æœç´¢æ‚£è€…å§“å..."
      style="width:100%;height:44px;border:1px solid var(--border-color);border-radius:8px;padding:0 12px;font-size:14px;box-sizing:border-box;background:var(--bg-page);">
  </div>
  <div class="patient-list" id="patientList">
    <div class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <div class="empty-text">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- åŒºåŸŸå››ï¼šæ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <a href="patient-add.html" class="fab">+</a>

  <script type="module">
    import { supabase } from '../js/supabase-client.js'

    // è·å–æœ¬å‘¨ä¸€çš„æ—¥æœŸå­—ç¬¦ä¸²
    function getMondayOfCurrentWeek() {
      const now = new Date()
      const dayOfWeek = now.getDay() // 0=å‘¨æ—¥
      const monday = new Date(now)
      // å‘¨ä¸€ = å½“å‰æ—¥æœŸ - (å½“å‰æ˜ŸæœŸå‡  - 1)ï¼Œå‘¨æ—¥ç‰¹æ®Šå¤„ç†
      const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1
      monday.setDate(now.getDate() - daysToSubtract)
      monday.setHours(0, 0, 0, 0)
      return monday
    }

    // è®¡ç®—æœ¬å‘¨å¤©æ•°ï¼ˆå‘¨ä¸€è‡³ä»Šï¼‰
    function getDaysThisWeek() {
      const now = new Date()
      const dayOfWeek = now.getDay() // 0=å‘¨æ—¥
      return dayOfWeek === 0 ? 7 : dayOfWeek
    }

    // è·å–æ‚£è€…æœ¬å‘¨å®Œæˆç‡æ•°æ®
    async function getPatientWeeklyProgress(patientId) {
      const monday = getMondayOfCurrentWeek()
      const now = new Date()

      // æŸ¥è¯¢è¯¥æ‚£è€…çš„ä»»åŠ¡æ•°é‡
      const { data: tasks } = await supabase
        .from('daily_tasks')
        .select('id')
        .eq('patient_id', patientId)

      const taskCount = tasks?.length || 0

      // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œè¿”å›æœªå¼€å§‹çŠ¶æ€
      if (taskCount === 0) {
        return { percent: null, lastCheckin: null }
      }

      // æŸ¥è¯¢æœ¬å‘¨æ‰“å¡è®°å½•
      const { data: logs } = await supabase
        .from('task_logs')
        .select('completed_at')
        .eq('patient_id', patientId)
        .gte('completed_at', monday.toISOString())
        .lte('completed_at', now.toISOString())
        .order('completed_at', { ascending: false })

      // è®¡ç®—å®Œæˆç‡
      const daysThisWeek = getDaysThisWeek()
      const expectedTotal = taskCount * daysThisWeek
      const actualTotal = logs?.length || 0
      const percent = Math.min(Math.round((actualTotal / expectedTotal) * 100), 100)

      // æœ€è¿‘æ‰“å¡æ—¶é—´
      let lastCheckin = null
      if (logs && logs.length > 0) {
        const lastDate = new Date(logs[0].completed_at)
        const today = new Date()
        today.setHours(0, 0, 0, 0)
        
        if (lastDate >= today) {
          lastCheckin = 'ä»Šå¤©'
        } else {
          const yesterday = new Date(today)
          yesterday.setDate(yesterday.getDate() - 1)
          if (lastDate >= yesterday) {
            lastCheckin = 'æ˜¨å¤©'
          } else {
            const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24))
            lastCheckin = `${diffDays}å¤©å‰`
          }
        }
      }

      return { percent, lastCheckin }
    }

    // åŠ è½½å¼‚å¸¸å¯¹è¯è®°å½•
    async function loadFlaggedChats(doctorId) {
      try {
        // æŸ¥è¯¢è¯¥åŒ»ç”Ÿæ‰€æœ‰æ‚£è€…çš„ flagged å¯¹è¯
        const { data: patients } = await supabase
          .from('patients')
          .select('id, name')
          .eq('doctor_id', doctorId)

        if (!patients || patients.length === 0) return

        const patientIds = patients.map(p => p.id)
        const patientMap = Object.fromEntries(patients.map(p => [p.id, p.name]))

        const { data: flaggedLogs, error } = await supabase
          .from('chat_logs')
          .select('*')
          .in('patient_id', patientIds)
          .eq('flagged_for_doctor', true)
          .order('created_at', { ascending: false })
          .limit(20)

        if (error) throw error

        if (!flaggedLogs || flaggedLogs.length === 0) return

        // æ˜¾ç¤ºå¼‚å¸¸åŒºå—
        const section = document.getElementById('flaggedSection')
        const countEl = document.getElementById('flaggedCount')
        const listEl = document.getElementById('flaggedList')

        section.style.display = 'block'
        countEl.textContent = flaggedLogs.length

        // æ¸²æŸ“åˆ—è¡¨
        listEl.innerHTML = flaggedLogs.map(log => {
          const patientName = patientMap[log.patient_id] || 'æœªçŸ¥æ‚£è€…'
          const content = log.content.length > 30 ? log.content.slice(0, 30) + '...' : log.content
          const time = formatTime(log.created_at)

          return `
            <div style="background:#fff;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;" 
                 onclick="window.location.href='patient-detail.html?id=${log.patient_id}'">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                <span style="font-weight:600;color:#856404;">${patientName}</span>
                <span style="font-size:12px;color:#9CA3AF;">${time}</span>
              </div>
              <div style="font-size:13px;color:#6B7280;">${content}</div>
            </div>
          `
        }).join('')
      } catch (err) {
        console.error('åŠ è½½å¼‚å¸¸å¯¹è¯å¤±è´¥:', err)
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(dateStr) {
      const date = new Date(dateStr)
      const now = new Date()
      const diffMs = now - date
      const diffMins = Math.floor(diffMs / 60000)
      const diffHours = Math.floor(diffMs / 3600000)
      const diffDays = Math.floor(diffMs / 86400000)

      if (diffMins < 1) return 'åˆšåˆš'
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`
      if (diffDays < 7) return `${diffDays}å¤©å‰`
      return date.toLocaleDateString('zh-CN')
    }

    // éªŒè¯ç™»å½•çŠ¶æ€å¹¶åˆå§‹åŒ–
    async function init() {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        window.location.href = '../index.html'
        return
      }

      // åŠ è½½å¼‚å¸¸å¯¹è¯è®°å½•
      loadFlaggedChats(session.user.id)

      // æ‹‰å–æ‚£è€…åˆ—è¡¨
      const { data: patients, error } = await supabase
        .from('patients')
        .select('*')
        .eq('doctor_id', session.user.id)
        .order('created_at', { ascending: false })

      if (error) {
        console.error('è·å–æ‚£è€…åˆ—è¡¨å¤±è´¥:', error)
        renderPatients([])
        return
      }

      // å…ˆæ¸²æŸ“åŸºç¡€åˆ—è¡¨
      renderPatients(patients || [])
      
      // ä¸²è¡ŒæŸ¥è¯¢æ¯ä¸ªæ‚£è€…çš„å®Œæˆç‡
      const patientsWithProgress = []
      let totalWeekCheckins = 0

      for (const patient of (patients || [])) {
        const progress = await getPatientWeeklyProgress(patient.id)
        patientsWithProgress.push({ ...patient, progress })
        if (progress.percent !== null) {
          totalWeekCheckins += Math.round((progress.percent / 100) * (await getPatientTaskCount(patient.id)) * getDaysThisWeek())
        }
      }

      // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
      renderPatientsWithProgress(patientsWithProgress)
      
      // æ›´æ–°ç»Ÿè®¡
      document.getElementById('totalPatients').textContent = patients.length
      document.getElementById('weekCheckins').textContent = totalWeekCheckins > 0 ? totalWeekCheckins : '-'
      document.getElementById('pendingReview').textContent = '-'
    }

    // è·å–æ‚£è€…ä»»åŠ¡æ•°é‡ï¼ˆç¼“å­˜ç‰ˆï¼‰
    async function getPatientTaskCount(patientId) {
      const { data: tasks } = await supabase
        .from('daily_tasks')
        .select('id')
        .eq('patient_id', patientId)
      return tasks?.length || 0
    }

    // æ¸²æŸ“æ‚£è€…åˆ—è¡¨ï¼ˆåŸºç¡€ç‰ˆï¼Œå…ˆæ˜¾ç¤ºï¼‰
    function renderPatients(patients) {
      const container = document.getElementById('patientList')

      if (patients.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ‘¥</div>
            <div class="empty-text">è¿˜æ²¡æœ‰æ‚£è€…ï¼Œç‚¹å‡»å³ä¸‹è§’æ·»åŠ ç¬¬ä¸€ä½</div>
          </div>
        `
        return
      }

      container.innerHTML = patients.map(patient => {
        const age = patient.age ? `${patient.age}å²` : ''
        const diagnosis = patient.diagnosis || 'æœªå¡«å†™è¯Šæ–­'
        
        return `
          <div class="patient-card" onclick="window.location.href='patient-detail.html?id=${patient.id}'">
            <div class="patient-header">
              <div>
                <span class="patient-name">${patient.name}</span>
                <span class="patient-age">${age}</span>
              </div>
            </div>
            <div class="patient-diagnosis">${diagnosis}</div>
            <div class="patient-footer">
              <div class="last-checkin">åŠ è½½ä¸­...</div>
              <div class="progress-mini">
                <div class="progress-mini-bar">
                  <div class="progress-mini-fill" style="width: 0%"></div>
                </div>
                <span class="progress-mini-text">è®¡ç®—ä¸­...</span>
              </div>
            </div>
          </div>
        `
      }).join('')
    }

    // å…¨å±€æ‚£è€…æ•°æ®ï¼ˆç”¨äºæœç´¢ç­›é€‰ï¼‰
    let allPatientsWithProgress = []

    // æ¸²æŸ“æ‚£è€…åˆ—è¡¨ï¼ˆå¸¦å®Œæˆç‡ï¼‰
    function renderPatientsWithProgress(patients) {
      // ä¿å­˜åˆ°å…¨å±€å˜é‡
      allPatientsWithProgress = patients

      const container = document.getElementById('patientList')

      container.innerHTML = patients.map(patient => {
        const age = patient.age ? `${patient.age}å²` : ''
        const diagnosis = patient.diagnosis || 'æœªå¡«å†™è¯Šæ–­'
        const { percent, lastCheckin } = patient.progress || {}
        
        // å®Œæˆç‡æ˜¾ç¤º
        const progressText = percent === null ? 'æš‚æœªå¼€å§‹' : `æœ¬å‘¨ ${percent}%`
        const progressWidth = percent || 0
        
        // æœ€è¿‘æ‰“å¡æ˜¾ç¤º
        const lastCheckinText = lastCheckin || 'æš‚æ— æ‰“å¡'
        
        return `
          <div class="patient-card" onclick="window.location.href='patient-detail.html?id=${patient.id}'">
            <div class="patient-header">
              <div>
                <span class="patient-name">${patient.name}</span>
                <span class="patient-age">${age}</span>
              </div>
            </div>
            <div class="patient-diagnosis">${diagnosis}</div>
            <div class="patient-footer">
              <div class="last-checkin">æœ€è¿‘æ‰“å¡ï¼š${lastCheckinText}</div>
              <div class="progress-mini">
                <div class="progress-mini-bar">
                  <div class="progress-mini-fill" style="width: ${progressWidth}%"></div>
                </div>
                <span class="progress-mini-text">${progressText}</span>
              </div>
            </div>
          </div>
        `
      }).join('')
    }

    // é€€å‡ºç™»å½•
    async function logout() {
      const confirmed = confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')
      if (!confirmed) return
      await supabase.auth.signOut()
      window.location.href = '../index.html'
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('avatarBtn').addEventListener('click', logout)

    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('searchInput')
    searchInput.addEventListener('input', () => {
      const keyword = searchInput.value.trim()
      const container = document.getElementById('patientList')

      if (!keyword) {
        // æ¸…ç©ºæœç´¢ï¼Œæ¢å¤æ˜¾ç¤ºå…¨éƒ¨
        renderPatientsWithProgress(allPatientsWithProgress)
        return
      }

      // æœ¬åœ°ç­›é€‰
      const filtered = allPatientsWithProgress.filter(p => p.name.includes(keyword))

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <div class="empty-text">æ²¡æœ‰æ‰¾åˆ°ã€Œ${keyword}ã€ç›¸å…³çš„æ‚£è€…</div>
          </div>
        `
        return
      }

      renderPatientsWithProgress(filtered)
    })

    // åˆå§‹åŒ–
    init()
  </script>
</body>
</html>